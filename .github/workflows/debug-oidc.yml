name: debug-oidc
on:
  workflow_dispatch:   # manual button

permissions:
  id-token: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: grab OIDC token
        run: |
          TOKEN=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com" | jq -r .value)
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: decode token (optional, safe)
        run: |
          jq -R 'split(".") | .[1] | @base64d | fromjson' <<< "${{ env.TOKEN }}"

      - name: assume role with real token
        run: |
          aws sts assume-role-with-web-identity \
            --role-arn arn:aws:iam::628087992272:role/github-actions-terraform \
            --role-session-name debug \
            --web-identity-token ${{ env.TOKEN }}